# Database

## DBの種類

- SQL-RDB
  - データの一貫性とトランザクション機能を有する
  - table結合等による、複雑なデータ操作ができる
  - e.g. mySQL, Oracle Database
- NoSQL
  - 通常のSQL (RDB) 以外の総称
  - 高速大容量処理
  - 画像やJSONの処理に優れる
  - リレーションを持たない
  - スケールアウトが容易
  - SQLに劣るデータ一貫性
- NewSQL
  - RDBとNoSQLのいいとこどりをめざす
    - スケールアウト、分散DB化ができるといった、拡張性や柔軟性
    - SQLが利用でき、トランザクションをサポート
  - 例：
    - Google Cloud Spanner
    - Cochroach DB
    - TiDB

## NoSQLの分類

- **key-value型**
  - keyとvalueの1対1管理による高速処理
  - 結合処理はできず、複雑な検索は不向き
  - 例：Redis
    - インメモリデータストア
    - 高速処理が可能で数百万件/秒の処理が可能
    - キャッシュ・チャットメッセージなどの用途
- **column指向型**
- 1つのkeyに、複数のcolumnが対応する 
- RDBは行 (1データ) 単位が得意だが、column指向型は列単位の処理が得意
- 例：Cassandra
- **graph型**
  - node, property, edgeから成り、ネットワーク状データの保存に適する
  - 例；Neo4j
- **Document型**
  - JSONやXMLでデータを保存する
  - 例：MongoDB
    - JSON形式でデータを保存できる

## MigrationTool
スキーマ定義やテーブル更新のコード化、作業履歴の保存などを行うことができる。  
Ruby on Railsなどではデフォルトで利用できるらしい。例は以下の通り。

- sql-migrate
- flyway

## sqlの設計

### DBの3層スキーマ

- 外部スキーマ: ユーザーから見た定義。出力されるデータやビュー。
- 概念スキーマ: データの関連性などを示す設計図。
- 内部スキーマ: 概念スキーマをDBにいれるための情報。型とかいろいろ。

### 設計のフェーズ

- 概念設計: エンティティ（テーブル）と関連（リレーション）にデータを落とし込む。
- 論理設計: データ型の定義や正規化を行い、ER図を作成する。 (概念と一緒くたに論理設計と呼ばれることも)
- 物理設計: テーブル定義・インデックス定義・DBの構成検討などを行う

### 正規化

- 第一正規化
  - 繰り返しを排除する
  - 1つのセルには1つの要素
- 第二正規化
  - テーブルのすべての候補キーで、部分関数従属を排して完全関数従属にする
  - e.g. (社員名、部署ID、部署名) => (社員名、部署ID), (部署ID、部署名)
- 第三正規化
  - 非キー属性→非キー属性の関数従属 (推移関数従属性) を排除する


## トランザクション処理

DBおいて、1つ以上の操作をまとめて単一の処理として実行する単位をトランザクションとと呼ぶ。

### ACID特性

- 原子性 (Atomicity): トランザクションは全ての操作が成功するか、一切成功しないかのいずれかとなる。途中でエラーが発生した場合、全ての変更を取り消して元の状態に戻す。
- 一貫性 (Consistency): トランザクションの開始前と終了後でデータベースは一貫性がある状態を維持する。
- 隔離性 (Isolation): 複数のトランザクションが同時に実行されても、各トランザクションは互いに影響を与えず、完了するまで他のトランザクションはその変更を見られない。
- 耐久性 (Durability): トランザクションが完了すると、その結果は永続的であり、データベースの障害が発生しても保持される。

### ロック

ロックには以下の種類がある。

- 共有ロック: 複数のトランザクションが同時に読み取りアクセスすることを許可する。書き込みアクセスは禁止。
- 排他/占有ロック: トランザクションがデータを更新するときに使用される。他のトランザクションが同時に共有ロックや排他ロックを取得できない。

## その他

### ストアドプロシージャ（Stored Procedure）

DBMS内に保存されている事前にコンパイルされたSQLコードの塊のこと。  
以下の特徴がある。

- 再利用性: データベース内に保存されており、アプリケーションから呼び出すことができ、同じロジックを複数の場所で再利用できる。
- パフォーマンス: データベースにプリコンパイルされて保存されるため、実行速度の向上と、ネットワークトラフィックの削減に寄与する。
- セキュリティ: データベース内で実行されるため、適切なアクセス権の設定によりセキュリティを確保できる。
- トランザクションのサポート: ストアドプロシージャはトランザクション内で使用することができ、一連の処理をアトミックに実行することができます。
- データ整合性の強制: スデータ整合性を強制するための条件やビジネスルールを実装できる

## 備考

sample-database: https://dev.mysql.com/doc/index-other.html : sakila

## 参考文献

- https://products.sint.co.jp/siob/blog/nosql
- https://tracpath.com/works/development/nosql_overview/
- https://qiita.com/cocoa-maemae/items/d55c7b53f95425efdce8

